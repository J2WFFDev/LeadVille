# LeadVille Impact Bridge - Handoff Document
**Date:** October 3, 2025  
**Branch:** `feature/refactor-paths-and-parsers`  
**Status:** ‚úÖ Functional - Impact Detection Working

---

## Session Summary

Successfully debugged and fixed impact detection system after refactoring. The bridge now correctly detects brief impact spikes from the BT50 sensor and correlates them with timer shot events.

---

## Critical Fixes Implemented Today

### 1. **Log File Path Fix** (Commit: a3f653c)
**Problem:** After refactoring code into `src/impact_bridge/`, log files were being written to wrong location (`src/impact_bridge/logs/` instead of project root `logs/`)

**Fix:** Updated `setup_dual_logging()` to navigate correctly:
```python
project_root = Path(__file__).parent.parent.parent  # From src/impact_bridge/ to project root
log_dir = project_root / 'logs' / 'console'
```

**Result:** Logs now written to `/home/jrwest/projects/LeadVille/logs/console/` where FastAPI can find them for web interface.

---

### 2. **Impact Detection Algorithm Fix** (Commit: 44885f9)
**Problem:** Only checking X-axis deviation, missing impacts on Y/Z axes

**Before:**
```python
shot_event = self.shot_detector.process_sample(vx_dev, timestamp)  # Only X-axis
```

**After:**
```python
max_axis_dev = max(abs(vx_dev), abs(vy_dev), abs(vz_dev))
shot_event = self.shot_detector.process_sample(max_axis_dev, timestamp)  # All axes
```

**Result:** Now detects impacts regardless of sensor orientation (e.g., 112 mm/s on Z-axis now detected).

---

### 3. **Single-Sample Impact Detection** (Commit: 4b4c0ce)
**Problem:** Required 6-11 consecutive samples above threshold, but taps create brief single-sample spikes

**Configuration Change:**
```yaml
shot_detection:
  min_duration: 1  # Changed from 6 to 1 for brief impact spikes
```

**Detector Change:**
```python
def __init__(self, min_duration: int = 1, ...)  # Changed default from 6 to 1
```

**Result:** Detects brief tap impacts (single 50-100+ mm/s spikes) instead of only sustained vibrations.

---

### 4. **Timing Calibrator Compatibility** (Commit: c9fd86a)
**Problem:** Bridge calling `record_impact()` but method named `add_impact_event()`

**Fix:** Added alias method:
```python
def record_impact(self, timestamp: datetime, magnitude: float):
    """Alias for add_impact_event for backward compatibility"""
    self.add_impact_event(timestamp, magnitude, device_id="sensor")
```

**Result:** No more `'RealTimeTimingCalibrator' object has no attribute 'record_impact'` errors.

---

### 5. **Database Logging Fix** (Commit: e08043c)
**Problem:** `'BleakGATTCharacteristic' object has no attribute 'service'` when logging impacts to database

**Before:**
```python
sensor_mac = characteristic.service.device.address.replace(':', '').upper()  # ‚ùå Failed
```

**After:**
```python
sensor_mac = self.bt50_client.address.replace(':', '').upper() if self.bt50_client else 'UNKNOWN'  # ‚úÖ Works
```

**Result:** Impacts now successfully logged to `db/leadville_runtime.db` without errors.

---

### 6. **Frontend Dependency Fix** (Commit: 9c13569)
**Problem:** Frontend build failing with `Failed to resolve import @heroicons/react/24/outline`

**Fix:** Added missing dependency to `frontend/package.json`:
```json
"dependencies": {
  "@heroicons/react": "^2.2.0"
}
```

**Result:** Frontend builds and runs without import errors.

---

## Current System Status

### ‚úÖ **Working Features**
- **Timer Shot Detection:** AMG timer events correctly parsed (Start Beep, Shots, Stop Beep)
- **Impact Detection:** BT50 sensor detecting taps/impacts above 10 mm/s threshold
- **Multi-Axis Detection:** Correctly uses max deviation across X/Y/Z axes
- **Single-Sample Spikes:** Detects brief impacts (not just sustained vibrations)
- **Database Logging:** Impacts stored in `sensor_events` table without errors
- **Web Interface:** Live log displays events in real-time
- **Timing Correlation:** Shot-to-impact timing tracked (e.g., 548ms, 216ms delays)

### ‚ö†Ô∏è **Known Issues (Non-Critical)**
1. **FastAPI Backend Errors:**
   - `Error fetching shot_log data: no such table: shot_log` (table not created yet)
   - `Failed to send status update: 'LeadVilleMQTT' object has no attribute 'is_connected'` (MQTT not configured)
   - **Impact:** None - core logging via `/api/logs` works fine (200 OK)

2. **Log Message Confusion:**
   - Shot detector logs say "Shot X detected" for sensor impacts (terminology issue)
   - Banner shows "6-11 sample duration" but configured for 1-11 (outdated message)
   - Impact counter resets between strings

### üîß **Configuration**
```yaml
# config/development.yaml
shot_detection:
  threshold: 10.0        # mm/s deviation from baseline
  min_duration: 1        # Samples (1 for impacts, 6+ for sustained shots)
  max_duration: 11       # Upper bound
  min_interval: 1.0      # Seconds between accepted impacts
```

---

## Test Results

### Test Session (19:33:50 - 19:34:17)
**String 2 with 2 timer shots:**
- **Impact #1:** 24 mm/s peak (detected 770ms after string start)
- **Impact #2:** 26 mm/s peak (standalone tap, no timer correlation)

### Extended Test Session (19:07-19:09)
**10 impacts detected** ranging from 11-101 mm/s:
- Light taps: 11-21 mm/s (just above 10 mm/s threshold)
- Moderate taps: 24-34 mm/s
- Strong taps: 61-101 mm/s

**Detection Success Rate:** 100% - All tap intensities detected correctly.

---

## Deployment Status

### **Raspberry Pi (pitts)**
- **Branch:** `feature/refactor-paths-and-parsers` (commit e08043c)
- **Services Running:**
  - `leadville-bridge.service` - Active, detecting impacts ‚úÖ
  - `leadville-fastapi.service` - Active, serving API ‚úÖ
  - `leadville-frontend.service` - Active, Vite dev server on port 5173 ‚úÖ
- **Configuration:** Using `config/development.yaml`
- **Logs:** Writing to `/home/jrwest/projects/LeadVille/logs/console/`
- **Database:** Impacts logging to `db/leadville_runtime.db`

### **Local Development**
- **Branch:** `feature/refactor-paths-and-parsers` (commit e08043c)
- **Uncommitted Changes:** `leadville.service` (systemd service file edits)

---

## Code Changes Summary

### Files Modified (7 commits today)
1. `src/impact_bridge/leadville_bridge.py` - Log paths, impact detection logic, database logging
2. `src/impact_bridge/shot_detector.py` - Min duration default changed to 1
3. `src/impact_bridge/timing_calibration.py` - Added `record_impact()` alias
4. `config/development.yaml` - Changed `min_duration: 6` to `min_duration: 1`
5. `frontend/package.json` - Added `@heroicons/react` dependency

### Commit History (Today)
```
e08043c - Fix impact database logging: use bt50_client.address instead of characteristic.service
c9fd86a - Add record_impact alias method to RealTimeTimingCalibrator
4b4c0ce - Enable single-sample impact detection for brief impact spikes
44885f9 - Fix impact detection: use max axis deviation instead of only vx
a3f653c - Fix log file path after refactoring - navigate to project root correctly
9c13569 - Add missing @heroicons/react dependency to frontend
9bc8ff6 - Consolidate bridge entry points and update threshold to 10 mm/s
```

---

## Next Steps / Future Work

### High Priority
1. **Improve Log Messages**
   - Rename "Shot detected" to "Impact detected" for sensor events
   - Fix banner to show correct "1-11 sample duration"
   - Clean up duplicate/confusing status messages

2. **Create shot_log Database Table**
   - Eliminate FastAPI 500 errors on `/api/shot-log` endpoint
   - Implement proper shot/impact correlation table

3. **MQTT Status Fix**
   - Fix or remove MQTT `is_connected` attribute check
   - Eliminate recurring status update errors

### Medium Priority
4. **Impact Counter Logic**
   - Decide on counter behavior (reset per string vs. continuous)
   - Make counter increment consistent

5. **Threshold Tuning**
   - Test with actual shooting (not just taps)
   - Determine if 10 mm/s is optimal for bullet impacts
   - May need different thresholds for timer vs. sensor events

### Low Priority
6. **Verbose Calibration Output**
   - Reduce calibration banner verbosity
   - Suppress CTRL+C status banner repeats

7. **Enhanced Detection Metrics**
   - Add confidence scores to impact detections
   - Track false positive/negative rates
   - Implement detection quality metrics

---

## Key Learnings / Notes

1. **Bleak API Changes:** The `characteristic.service.device.address` pattern no longer works - use `client.address` instead.

2. **Impact vs. Shot Detection:** Brief impacts (taps) create single-sample spikes, not sustained vibrations. Detector needs `min_duration: 1` for impact detection vs. `min_duration: 6-11` for shot detection.

3. **Sensor Orientation:** Must check all axes (X, Y, Z) since sensor mounting determines which axis shows the impact. Using `max(abs(vx), abs(vy), abs(vz))` solves this.

4. **Path Calculations After Refactoring:** When moving code into subdirectories, carefully update all relative path calculations (especially for logs, databases, config files).

5. **Log File Location Critical:** FastAPI reads logs from `logs/console/` - if bridge writes elsewhere, web interface shows stale data.

---

## System Architecture

```
LeadVille/
‚îú‚îÄ‚îÄ src/impact_bridge/          # Core bridge modules
‚îÇ   ‚îú‚îÄ‚îÄ leadville_bridge.py     # Main bridge logic
‚îÇ   ‚îú‚îÄ‚îÄ shot_detector.py        # Impact detection algorithm
‚îÇ   ‚îú‚îÄ‚îÄ timing_calibration.py   # Shot-impact correlation
‚îÇ   ‚îî‚îÄ‚îÄ ble/parsers.py          # BLE frame parsing
‚îú‚îÄ‚îÄ frontend/                   # React web interface
‚îú‚îÄ‚îÄ logs/console/               # Bridge console logs (read by FastAPI)
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ leadville.db           # Main database (bridge/sensor assignments)
‚îÇ   ‚îú‚îÄ‚îÄ leadville_runtime.db   # Impact events (sensor_events table)
‚îÇ   ‚îî‚îÄ‚îÄ bt50_samples.db        # Raw sensor samples
‚îî‚îÄ‚îÄ config/
    ‚îî‚îÄ‚îÄ development.yaml       # Runtime configuration
```

---

## Contact / Handoff

**Branch Ready for:** Testing with live shooting (not just taps)  
**Recommended Action:** Run full string tests to validate 10 mm/s threshold with actual bullet impacts  
**Known Safe State:** Commit e08043c - all critical functions working  

**Questions/Issues:** Refer to GitHub issues on `feature/refactor-paths-and-parsers` branch

---

## Quick Reference Commands

### Check Bridge Status
```bash
ssh jrwest@pitts "sudo systemctl status leadville-bridge --no-pager"
```

### View Live Logs
```bash
ssh jrwest@pitts "sudo journalctl -u leadville-bridge -f --no-pager"
```

### Restart Services
```bash
ssh jrwest@pitts "sudo systemctl restart leadville-bridge leadville-fastapi"
```

### Check Recent Impacts
```bash
ssh jrwest@pitts "sudo journalctl -u leadville-bridge --since '10 minutes ago' --no-pager | grep 'üí•'"
```

### Query Impact Database
```bash
ssh jrwest@pitts "sqlite3 projects/LeadVille/db/leadville_runtime.db 'SELECT * FROM sensor_events ORDER BY id DESC LIMIT 10;'"
```

---

**End of Handoff Document**  
*System Status: ‚úÖ Operational - Ready for Live Testing*
