<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Assignment - LeadVille Bridge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow border mb-6 p-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üéØ Device Assignment</h1>
            <p class="text-gray-600">Assign timer and sensor devices to bridge configuration</p>
            <a href="/docs/dashboard/system_status_dashboard.html" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to System Dashboard</a>
        </div>

        <!-- Current Assignment Status -->
        <div class="bg-white rounded-lg shadow border mb-6">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold text-gray-900">Current Bridge Configuration</h2>
            </div>
            <div class="p-6">
                <div id="current-assignment" class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Timer Device:</span>
                        <span id="current-timer" class="text-gray-600">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Sensor Devices:</span>
                        <span id="current-sensors" class="text-gray-600">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Assignment Interface -->
        <div class="bg-white rounded-lg shadow border mb-6">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold text-gray-900">Assign Devices</h2>
                <p class="text-sm text-gray-600 mt-1">Select devices from the pool to assign to bridge</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Timer Assignment -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                            <span class="mr-2">‚è±Ô∏è</span>
                            Timer Device
                        </h3>
                        
                        <select id="timer-select" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
                            <option value="">Loading timer devices...</option>
                        </select>
                        
                        <p class="text-sm text-gray-500 mt-2">Select the AMG Timer device for match timing</p>
                    </div>

                    <!-- Sensor Assignment -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                            <span class="mr-2">üì°</span>
                            Impact Sensors
                        </h3>
                        
                        <div id="sensor-list" class="space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <p class="text-gray-500">Loading sensor devices...</p>
                        </div>
                        
                        <p class="text-sm text-gray-500 mt-2">Select BT50 sensors for target impact detection</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 flex items-center space-x-4">
                    <button onclick="saveAssignment()" id="save-btn" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-base">
                        üíæ Save Assignment
                    </button>
                    <button onclick="clearAssignment()" 
                            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium text-base">
                        üóëÔ∏è Clear All
                    </button>
                    <button onclick="refreshData()" id="refresh-btn"
                            class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium text-base">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">üìã Instructions</h3>
            <ol class="list-decimal list-inside space-y-2 text-blue-800">
                <li><strong>Timer Assignment:</strong> Select your AMG Timer device from the dropdown</li>
                <li><strong>Sensor Assignment:</strong> Check the BT50 sensor devices you want to use</li>
                <li><strong>Save Configuration:</strong> Click "Save Assignment" to update bridge config</li>
                <li><strong>Bridge Integration:</strong> The bridge will connect to assigned devices automatically</li>
            </ol>
            <div class="mt-4 p-3 bg-blue-100 rounded text-sm">
                <strong>Note:</strong> Make sure devices are paired and showing in the device pool before assigning them.
            </div>
        </div>

        <!-- Notifications -->
        <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.hostname + ':8001';

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-blue-500 text-white',
                warning: 'bg-yellow-500 text-black'
            };
            
            notification.className = `${colors[type]} px-4 py-2 rounded-lg shadow-lg transition-all`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Fetch JSON with error handling
        async function fetchJSON(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        // Load current bridge configuration
        async function loadCurrentConfig() {
            const config = await fetchJSON(`${API_BASE}/api/admin/bridge/config`);
            
            if (config) {
                const timerAddr = config.timer?.address || 'None assigned';
                const timerStatus = config.timer?.status || 'not_configured';
                const sensors = config.sensors || [];
                
                document.getElementById('current-timer').innerHTML = `
                    <span class="font-mono">${timerAddr}</span>
                    <span class="ml-2 px-2 py-1 text-xs rounded ${timerStatus === 'configured' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">${timerStatus}</span>
                `;
                
                document.getElementById('current-sensors').textContent = `${sensors.length} sensors assigned`;
                
                // Update form with current values
                updateFormWithConfig(config);
            } else {
                document.getElementById('current-timer').textContent = 'Failed to load';
                document.getElementById('current-sensors').textContent = 'Failed to load';
            }
        }

        // Load available devices
        async function loadDevices() {
            const data = await fetchJSON(`${API_BASE}/api/admin/devices`);
            
            if (!data) {
                showNotification('Failed to load devices', 'error');
                return;
            }
            
            const devices = data.devices || [];
            console.log('Loaded devices:', devices);

            // Identify timer devices
            const timerDevices = devices.filter(d => {
                const isTimerByLabel = d.label && d.label.toLowerCase().includes('timer');
                const isTimerByAddress = d.address === '60:09:C3:1F:DC:1A'; // Known AMG Timer
                return isTimerByLabel || isTimerByAddress;
            });

            // Identify sensor devices
            const sensorDevices = devices.filter(d => {
                const isTimerByLabel = d.label && d.label.toLowerCase().includes('timer');
                const isTimerByAddress = d.address === '60:09:C3:1F:DC:1A';
                return !(isTimerByLabel || isTimerByAddress);
            });

            // Populate timer dropdown
            const timerSelect = document.getElementById('timer-select');
            timerSelect.innerHTML = '<option value="">No timer assigned</option>';
            
            timerDevices.forEach(timer => {
                const option = document.createElement('option');
                option.value = timer.address;
                const name = timer.label || 'AMG Timer';
                const addr = timer.address.slice(-8);
                const signal = timer.rssi ? `${timer.rssi} dBm` : 'N/A';
                option.textContent = `${name} (${addr}) - Signal: ${signal}`;
                timerSelect.appendChild(option);
            });

            // Populate sensor list
            const sensorList = document.getElementById('sensor-list');
            sensorList.innerHTML = '';
            
            if (sensorDevices.length === 0) {
                sensorList.innerHTML = '<p class="text-gray-500">No sensor devices available</p>';
            } else {
                sensorDevices.forEach(sensor => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-3 p-3 bg-white border rounded-lg';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = sensor.address;
                    checkbox.className = 'h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded';
                    checkbox.name = 'sensor-assignment';
                    
                    const label = document.createElement('label');
                    label.className = 'flex-1 cursor-pointer';
                    
                    const name = sensor.label || 'BT50 Sensor';
                    const addr = sensor.address.slice(-8);
                    const signal = sensor.rssi ? `${sensor.rssi} dBm` : 'N/A';
                    const battery = sensor.battery ? `${sensor.battery}%` : 'N/A';
                    
                    label.innerHTML = `
                        <div class="font-medium text-gray-900">${name}</div>
                        <div class="text-sm text-gray-500">${addr} ‚Ä¢ Signal: ${signal} ‚Ä¢ Battery: ${battery}</div>
                    `;
                    
                    label.addEventListener('click', () => {
                        checkbox.checked = !checkbox.checked;
                    });
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    sensorList.appendChild(div);
                });
            }

            showNotification(`Loaded ${timerDevices.length} timer(s) and ${sensorDevices.length} sensor(s)`, 'success');
        }

        // Update form with current configuration
        function updateFormWithConfig(config) {
            // Set timer selection
            const timerSelect = document.getElementById('timer-select');
            const currentTimer = config.timer?.address;
            
            if (currentTimer) {
                timerSelect.value = currentTimer;
            }
            
            // Set sensor checkboxes
            const currentSensors = config.sensors?.map(s => s.address) || [];
            const checkboxes = document.querySelectorAll('input[name="sensor-assignment"]');
            
            checkboxes.forEach(cb => {
                cb.checked = currentSensors.includes(cb.value);
            });
        }

        // Save device assignment
        async function saveAssignment() {
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.textContent;
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'üíæ Saving...';
                
                const timerSelect = document.getElementById('timer-select');
                const selectedTimer = timerSelect.value || null;
                
                const sensorCheckboxes = document.querySelectorAll('input[name="sensor-assignment"]:checked');
                const selectedSensors = Array.from(sensorCheckboxes).map(cb => cb.value);
                
                console.log('Saving assignment:', { timer: selectedTimer, sensors: selectedSensors });
                
                const response = await fetch(`${API_BASE}/api/admin/bridge/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timer: selectedTimer,
                        sensors: selectedSensors
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`‚úÖ Assignment saved: ${selectedTimer ? '1 timer' : 'no timer'}, ${selectedSensors.length} sensors`, 'success');
                    
                    // Refresh current config display
                    await loadCurrentConfig();
                } else {
                    const error = await response.json();
                    showNotification(`‚ùå Save failed: ${error.error || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                showNotification('‚ùå Save failed: Network error', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // Clear all assignments
        async function clearAssignment() {
            if (!confirm('Clear all device assignments from bridge configuration?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/bridge/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        timer: null,
                        sensors: []
                    })
                });
                
                if (response.ok) {
                    showNotification('üóëÔ∏è All assignments cleared', 'success');
                    
                    // Clear form
                    document.getElementById('timer-select').value = '';
                    document.querySelectorAll('input[name="sensor-assignment"]').forEach(cb => {
                        cb.checked = false;
                    });
                    
                    // Refresh current config
                    await loadCurrentConfig();
                } else {
                    const error = await response.json();
                    showNotification(`‚ùå Clear failed: ${error.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Clear error:', error);
                showNotification('‚ùå Clear failed: Network error', 'error');
            }
        }

        // Refresh all data
        async function refreshData() {
            const refreshBtn = document.getElementById('refresh-btn');
            const originalText = refreshBtn.textContent;
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'üîÑ Refreshing...';
                
                await Promise.all([
                    loadCurrentConfig(),
                    loadDevices()
                ]);
                
                showNotification('üîÑ Data refreshed', 'success');
                
            } catch (error) {
                console.error('Refresh error:', error);
                showNotification('‚ùå Refresh failed', 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = originalText;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Device Assignment page loaded');
            
            showNotification('Loading device assignment interface...', 'info');
            
            try {
                await Promise.all([
                    loadCurrentConfig(),
                    loadDevices()
                ]);
                
                showNotification('‚úÖ Device assignment interface ready', 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('‚ùå Failed to initialize interface', 'error');
            }
        });
    </script>
</body>
</html>