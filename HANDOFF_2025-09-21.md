Handoff: LeadVille Bridge — Activities for 2025-09-21

Summary
-------
Date: 2025-09-21
Primary goal: Bring up the LeadVille LED/BT50/AMG bridge on the Raspberry Pi, capture BT50 raw primitives and AMG timer events into the WAL-enabled SQLite capture DB, and verify end-to-end persistence of timer START/SHOT/STOP events.

What I worked on
-----------------
- Parser & capture pipeline
  - Implemented authoritative BT50/WTVB BLE frame parser modules: `src/impact_bridge/ble/wtvb_parse.py` and `wtvb_parse_simple.py`.
  - Implemented a multi-sensor capture CLI `tools/bt50_capture_db.py` using a single-writer asyncio queue with batched commits. It creates the capture DB schema including `bt50_samples`, `impacts`, `device_status`, `device_status_history`, and `timer_events`.

- Bridge changes
  - Added synchronous bridge-side persistence for timer events in `src/impact_bridge/leadville_bridge.py` via `_persist_timer_event(...)` which writes into `logs/bt50_samples.db`.
  - Converted relative imports to absolute package imports (`impact_bridge.*`) and replaced the large repo-root `leadville_bridge.py` with a minimal launcher that inserts `src` into `sys.path` and runs the package entrypoint.
  - Defensive changes to timing calibrator initialization to tolerate `dev_config` API differences: removed passing `expected_delay_ms` into `RealTimeTimingCalibrator` ctor and instead apply configured expected delay after construction.

- Tools & maintenance
  - Added `tools/bt50_prune.py` and a wrapper for scheduled DB pruning + vacuum (systemd timer planned).
  - Wrote monitor/test helpers and small scripts to tail console logs and poll the capture DB for new rows.

Deploy & debugging activities on Pi
----------------------------------
- Replaced the launcher `leadville_bridge.py` on the Pi to avoid the "attempted relative import with no known parent package" error.
- Iteratively deployed `src/impact_bridge/leadville_bridge.py` patches via `scp` and used `python3 -m py_compile` remotely to confirm syntax correctness.
- Cleared stale `*.pyc` files to avoid mixed bytecode during rapid restarts.

Key problems encountered & fixes
--------------------------------
- Problem: Initial ImportError due to a repo-root script using relative imports.
  - Fix: Replaced repo-root script with minimal launcher calling `impact_bridge.leadville_bridge.main()` and ensured `src` is discoverable.

- Problem: Merge-conflict artifacts and syntax errors appeared on Pi during intermediate deploys.
  - Fix: Cleaned files and re-deployed known-good versions; added `py_compile` checks before restart.

- Problem: `DevConfig` API mismatch — `get_expected_delay()` not present; additionally `RealTimeTimingCalibrator` constructor did not accept `expected_delay_ms` kwarg.
  - Fix: Added a defensive accessor `_cfg_get_expected_delay(cfg, default=1035)` and applied expected delay to `self.timing_calibrator.calibration.expected_delay_ms` after constructing the calibrator.

Current runtime status (as of end of day 2025-09-21)
--------------------------------------------------
- The bridge service (`leadville-bridge.service`) starts and initializes components without crashing.
- The bridge connects to the AMG timer (MAC `60:09:C3:1F:DC:1A`) and enables AMG shot notifications.
- The BT50 sensor (MAC `EA:18:3D:6D:BA:E5`) was not found during attempts — likely powered off or out of range.
- The capture DB `/home/jrwest/projects/LeadVille/logs/bt50_samples.db` contains the `timer_events` table but currently no rows were written by the bridge (no START/SHOT/STOP notifications received during capture window).
- Temporary monitor scripts were run and captured console logs and DB poll results; they indicated no new timer/sample/impact rows.

Files changed or added (not exhaustive)
-------------------------------------
- Modified: `src/impact_bridge/leadville_bridge.py` (timing calibrator defensive handling; `_persist_timer_event` added)
- Added: `tools/bt50_capture_db.py` (multi-sensor capture CLI and `db_writer`)
- Added: `tools/bt50_prune.py`, `tools/bt50_prune_wrapper.py`
- Added: `src/impact_bridge/ble/wtvb_parse.py`, `src/impact_bridge/ble/wtvb_parse_simple.py`
- Added: unit tests `tests/test_impact_detector.py` (ImpactDetector)
- Replaced: repo-root `leadville_bridge.py` with minimal package launcher
- Added: monitor helper script uploaded to `/tmp/bridge_monitor.py` (temporary)

Next recommended steps
----------------------
1. Bring both the AMG timer and the BT50 sensor into range and trigger the timer (press to START/SHOT/STOP) while the bridge is running. Capture should then write `timer_events` rows to `logs/bt50_samples.db`.
2. Harden the systemd unit to invoke the package module directly using `python3 -m impact_bridge.leadville_bridge` with `PYTHONPATH` set to `src/` to avoid future relative-import fragility.
3. Fix the temporary monitor script to match the current DB schema (use `device_id` rather than `device_mac` in queries) and make a durable capture-run tool in `tools/` for future runs.
4. If the BT50 sensor remains undiscoverable, run BLE diagnostics (`hciconfig`, `bluetoothctl` scan) and confirm the devices' MAC addresses and that their radios are on.

How to reproduce the test (quick)
--------------------------------
1. Start the bridge (systemd already configured):
   sudo systemctl restart leadville-bridge
2. Tail the console log to see AMG beeps and BT50 samples:
   tail -f src/impact_bridge/logs/console/bridge_console_YYYYMMDD_HHMMSS.log
3. While tailing, press the AMG timer/buttons or cause a shot event on the BT50 sensor. Check DB:
   python3 - <<PY
import sqlite3
con=sqlite3.connect('logs/bt50_samples.db')
for r in con.execute("SELECT * FROM timer_events ORDER BY ts_ns DESC LIMIT 20"):
    print(r)
con.close()
PY

Notes for the on-call engineer
-----------------------------
- If you see "no such column: device_mac" from monitoring scripts, update the script to use the actual columns — schema changed during development.
- Avoid rapid `scp` deploys without running `python3 -m py_compile` and removing old `.pyc` files; stale `.pyc` can cause confusing mixed-stack traces.
- If the bridge crashes with an AttributeError related to `dev_config`, inspect `src/impact_bridge/dev_config.py` for expected method names and consider keeping the defensive accessor.

Contact / follow-up
-------------------
- If you want, I can (A) update the systemd unit now, (B) fix the monitor script and run a longer capture while you power devices, or (C) run Bluetooth diagnostics on the Pi. Tell me which and I'll proceed.

-- End of handoff
