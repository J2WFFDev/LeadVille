# LeadVille Impact Detection - Session Handoff
**Date:** October 1, 2025  
**Session Time:** ~21:00 - 22:00  
**Branch:** feature/refactor-paths-and-parsers  
**Status:** BROKEN - Impact detection not working

> **Oct 2, 2025 update:** The legacy `parse_5561` parser referenced throughout
> this handoff has been archived. Active bridge builds now use
> `parse_bt50_frame` exclusively; retain the notes below for historical
> debugging context only.

---

## What Was Working (Before This Session)
- Bridge was detecting impacts (even if values were odd/offset)
- Sensors reported "2400g" continuously - FALSE POSITIVES but at least detecting
- 46 impacts logged in production database (leadville_runtime.db)
- Peak magnitudes: 10-134 mm/s range in production data

---

## What We Changed (And Broke Things)

### The Fatal Change: Switched Parsers
**File Modified:** `leadville_bridge.py`

**Changed FROM:**
```python
from impact_bridge.ble.parsers import parse_5561
```

**Changed TO:**
```python
from impact_bridge.ble.parsers import parse_flag61_frame
```

**Lines Modified:**
- Line 71: Import statement
- Line 351: Calibration handler
- Line 637: Per-sensor calibration handler  
- Line 694: Second per-sensor calibration handler
- Line 908: Main sensor data processing

### Why We Changed It (The Theory)
We discovered that `parse_5561` was reading the 28-byte flag61 frame incorrectly:
- It looped through bytes 2-7, 8-13, 14-19, etc. treating them as multiple acceleration samples
- **Byte 14-15 contained TEMPERATURE (~2235 = 22.35°C)** which was being read as "vx=2235"
- This is where the "2400g" false positives came from
- We thought switching to `parse_flag61_frame` would fix it

### What Actually Happened (The Reality)
After switching parsers:
- ✅ Bridge connects to sensors successfully
- ✅ Calibration completes (X=0.0, Y=0.0, Z=0.0)
- ✅ Parser correctly reads flag61 frames
- ❌ **ALL velocity values are now ZERO** (vx=0, vy=0, vz=0)
- ❌ **NO impacts detected at all**
- ❌ Debug log shows continuous frames with all-zero velocity

---

## Current System State

### File Locations
**Main Bridge File:** `c:\sandbox\TargetSensor\LeadVille\leadville_bridge.py` (1228 lines)  
**On Pi:** `/home/jrwest/projects/LeadVille/leadville_bridge.py`

**Parser Files:**
- `src/impact_bridge/ble/parsers/simple_5561.py` - The OLD parser (reads acceleration)
- `src/impact_bridge/ble/parsers/verbose.py` - Contains `parse_flag61_frame` (reads velocity)

### Pi Connection
- **Host:** pitts (192.168.1.131)
- **User:** jrwest
- **Working Directory:** /home/jrwest/projects/LeadVille
- **Bridge Process:** Multiple instances may be running (check with `ps aux | grep leadville_bridge.py`)

### Sensors
- **BT50-1 (Target 1):** DB:10:38:B6:13:6B (136B)
- **BT50-2 (Target 2):** C2:1B:DB:F0:55:50 (5550)
- **AMG Timer:** 60:09:C3:1F:DC:1A (DC:1A) - Working correctly

### Configuration
**Threshold:** 80.0 mm/s (in `config/development.yaml`)  
**Onset Threshold:** 30.0 mm/s

### Databases
- **bt50_samples.db:** 189,370 samples (last samples have valid velocity data 4-62 mm/s)
- **leadville_runtime.db:** 46 production impacts (10.68-34.29 mm/s peak values)

---

## The Mystery (What We Don't Understand)

### Database Shows Good Data (OLD)
Recent samples in database (IDs 189364-189370):
```
189370: vx=4,  vy=9,  vz=9   (mag ~13 mm/s)
189369: vx=5,  vy=2,  vz=3
189368: vx=3,  vy=7,  vz=9
189367: vx=24, vy=43, vz=29  (mag ~56 mm/s)
189366: vx=5,  vy=20, vz=6
189365: vx=30, vy=33, vz=33  (mag ~56 mm/s)
189364: vx=46, vy=62, vz=15  (mag ~78 mm/s)
```

### Live Debug Log Shows All Zeros (NEW)
Current frames being received (21:53:26 timestamp):
```
parse_flag61_frame: parsed={'vx': 0, 'vy': 0, 'vz': 0, ...}
parse_flag61_frame: parsed={'vx': 0, 'vy': 0, 'vz': 0, ...}
parse_flag61_frame: parsed={'vx': 0, 'vy': 0, 'vz': 0, ...}
```

Raw hex frames show: `b'Ua\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd4\x08...'`  
(First 12 payload bytes are all zeros)

### Possible Explanations
1. **Sensors went into standby/idle mode** - maybe they only report velocity when moving?
2. **Sensor configuration changed** - something reset them to zero-output mode?
3. **We're reading wrong characteristic** - maybe velocity is on a different UUID?
4. **Write_db=False broke something** - we're not writing samples to database anymore
5. **The old working code used parse_5561 intentionally** - maybe it WAS reading the right data, just from the "wrong" interpretation?

---

## What Definitely Works
✅ BLE connection to both sensors  
✅ AMG timer detection (saw 2 shots: 0.99s, 1.98s timing)  
✅ Sensor communication (receiving frames continuously)  
✅ Parser structure (no crashes, proper frame parsing)  
✅ Calibration completes successfully  

---

## What's Definitely Broken
❌ Velocity data all zeros  
❌ No impact detection  
❌ Threshold comparison never triggers (can't trigger on 0 values)  

---

## The Question for Tomorrow

**Should we have LEFT parse_5561 alone?**

The "2400g" value WAS temperature being misread as velocity, BUT:
- Maybe the sensors DON'T output velocity in bytes 2-7?
- Maybe the actual movement data IS in the temperature/displacement bytes?
- Maybe parse_5561 was "accidentally correct" by reading later bytes?

**OR: Are the sensors just idle/sleeping?**
- Database samples show they CAN output velocity (4-62 mm/s range)
- Current frames show all zeros
- Maybe sensors need physical movement to wake up?
- Maybe we need to HIT the sensors to get readings?

---

## Commands to Investigate Tomorrow

### Kill any running bridge instances:
```powershell
ssh jrwest@192.168.1.131 "pkill -f leadville_bridge.py"
```

### Check what's running:
```powershell
ssh jrwest@192.168.1.131 "ps aux | grep leadville_bridge.py | grep -v grep"
```

### Start bridge fresh:
```powershell
ssh jrwest@192.168.1.131 "cd /home/jrwest/projects/LeadVille && python3 leadville_bridge.py"
```

### Check latest log:
```powershell
ssh jrwest@192.168.1.131 "ls -lt /home/jrwest/projects/LeadVille/logs/console/*.log | head -1 | awk '{print \$9}' | xargs tail -50"
```

### Look at raw frames in real-time:
```powershell
ssh jrwest@192.168.1.131 "tail -f /home/jrwest/projects/LeadVille/logs/debug/bridge_debug_*.log | grep 'parse_flag61_frame: parsed'"
```

---

## Recommendations for Tomorrow

### Option 1: Revert Everything (SAFEST)
1. `git diff leadville_bridge.py` to see all changes
2. `git checkout leadville_bridge.py` to undo ALL parser changes
3. Test if impacts work again with parse_5561
4. If yes: The "wrong" parser was actually right

### Option 2: Investigate Sensor Behavior
1. Start bridge with current code
2. **Physically hit/move both sensors**
3. Watch debug log for velocity changes
4. Determine if sensors are just idle/sleeping

### Option 3: Compare Frame Formats
1. Get hex dump of old working frame (from database)
2. Get hex dump of current zero frame (from debug log)
3. Byte-by-byte comparison to find differences
4. Determine if frame FORMAT changed or just VALUES changed

### Option 4: Test Both Parsers Side-by-Side
1. Import BOTH parsers in bridge
2. Run both on same frame
3. Log both outputs
4. See which gives useful data during actual impacts

---

## Files Modified This Session
- `leadville_bridge.py` - Parser imports and all parse calls changed
- `test_parser_comparison.py` - Created for testing (can delete)

## Files NOT Modified (Still Old Working Versions)
- `src/impact_bridge/ble/parsers/simple_5561.py` - OLD parser still intact
- `src/impact_bridge/ble/parsers/verbose.py` - NEW parser still intact
- All databases intact (no data lost)

---

## My Apologies
I made this worse by:
1. Assuming the "2400g" was wrong without understanding WHY it was working
2. Changing too much at once without incremental testing
3. Not verifying sensors were actually outputting velocity BEFORE switching parsers
4. Getting stuck in analysis loops instead of suggesting a simple revert

The code you had WAS working (even with odd values). I broke it trying to "fix" it.

**Tomorrow: Start by reverting or test physical sensor movement first.**

---

## Quick Reference

**Current Parser:** parse_flag61_frame (reads bytes 2-7 as velocity)  
**Old Parser:** parse_5561 (reads bytes 2-7, 8-13, 14-19... as multiple acceleration samples)  
**Threshold:** 80.0 mm/s  
**Sensors:** Connected and sending frames (but all zeros)  
**Root Cause:** Unknown - either sensors idle or we're reading wrong data  

**Next Action:** Revert changes OR physically test sensors with movement
