HANDOFF: LeadVille bridge and FastAPI maintenance
Date: 2025-09-23

Summary
-------
Today I fixed FastAPI startup issues, standardized the capture DB path, cleaned repository root clutter, and restored the frontend dev server on the Pi.

What I did (high level)
-----------------------
- Standardized capture DB handling:
  - Introduced `CAPTURE_DB_PATH` env var.
  - Default canonical path: `<project_root>/db/bt50_samples.db`.
- FastAPI start script:
  - `scripts/start_fastapi.py` updated to import the `app` object directly to avoid uvicorn string-import under systemd.
- Fixed `src/impact_bridge/auth/auth.py` indentation bug that prevented FastAPI from importing.
- Repository reorg and cleanup:
  - Moved runtime helpers and one-off scripts to `scripts/` and `docs/dashboard/`.
  - Moved tests to `tests/` and helper scripts to `scripts/`.
  - Committed multiple reorg commits: `cfeb245`, `d29023f`, etc.
  - Created `scripts/ensure_layout.py` to audit and optionally move misplaced files.
  - Added pre-commit hook installer and hook (in `.githooks/pre-commit`) and installers in `scripts/`.
  - Added GitHub Actions:
    - `.github/workflows/layout-check.yml` to reject pushes/PRs with misplaced root files.
    - `.github/workflows/deploy-to-pi.yml` to deploy to the Pi on push to `main` (requires `PI_DEPLOY_KEY` secret).
- Frontend fixes and dev server:
  - Added placeholder `frontend/src/components/NetworkManager.tsx` to resolve Vite import error.
  - Fixed script imports referencing `src` (updated paths in `scripts/` to point to `../src`).
  - Started frontend dev server on the Pi; Vite reported it at `http://localhost:5174/` (port 5173 in use).

Files changed (not exhaustive, notable)
--------------------------------------
- `scripts/ensure_layout.py` (new)
- `.githooks/pre-commit` (new)
- `scripts/install_precommit_hook.sh` (new)
- `scripts/install_precommit_hook.ps1` (new)
- `.github/workflows/layout-check.yml` (new)
- `.github/workflows/deploy-to-pi.yml` (new)
- `scripts/*` (moved/updated helper scripts)
- `tests/*` (moved tests)
- `frontend/src/components/NetworkManager.tsx` (new placeholder)
- `scripts/start_fastapi.py` (updated)
- `src/impact_bridge/auth/auth.py` (fixed)

Pi state and deployment
-----------------------
- On the Pi, I ran `git reset --hard origin/main` to align with the repo and started the frontend dev server.
- Systemd service `leadville-fastapi.service` was previously verified to run Uvicorn successfully.

Next actions recommended
------------------------
- Add `PI_DEPLOY_KEY` secret in GitHub for automatic deploy action.
- Install local pre-commit hook on developer machines:
  - `bash scripts/install_precommit_hook.sh` or
  - `powershell -ExecutionPolicy Bypass -File scripts/install_precommit_hook.ps1`
- Review docs that still reference legacy `logs/` paths and update to `db/` or note `CAPTURE_DB_PATH`.
- Run live sensor tests to confirm bridge writes to capture DB during operation.

How to reproduce local dev (quick)
---------------------------------
- Backend:
  - `python -m venv .venv`
  - `pip install -r requirements.txt`
  - `python scripts/start_fastapi.py` (or use systemd on Pi)
- Frontend:
  - `cd frontend`
  - `npm install`
  - `npm run dev`

Contact/Notes
-------------
If anything regresses on the Pi, I'll be available to debug further. The `HANDOFF_2025-09-23.md` is intentionally concise; ask for more detail on any item and I'll expand it.
